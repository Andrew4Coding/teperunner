{% extends "base.html" %} 
{% block content %}
<div class="container mx-auto max-w-3xl p-6 space-y-6">
	<!-- Title Section -->
	<header class="text-center">
		<h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center gap-3">
			<i class="fas fa-terminal text-blue-600"></i>
			<span>Run TP 3</span>
		</h1>
		<p class="text-sm text-gray-500">Made with ðŸ’– by Andrew</p>
	</header>

	<!-- Tip Jar -->
	<div class="hidden lg:block fixed bottom-4 right-4 max-w-[240px] bg-blue-100 border border-blue-300 rounded-lg p-4 shadow-lg">
		<h2 class="text-blue-800 font-semibold mb-2 flex items-center gap-2">
			<i class="fas fa-lightbulb"></i> Tip Jar
		</h2>
		<p class="text-gray-600 text-sm mb-3">Found this tool helpful? Consider leaving a tip! ðŸ’–</p>
		<a href="https://teer.id/andrew_devito_aryo" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-4 rounded-lg shadow-md transition inline-flex items-center gap-2">
			<i class="fas fa-ice-cream"></i> Buy me an Ice Cream
		</a>
	</div>

	<!-- File Upload -->
	<section class="bg-white rounded-lg shadow p-6">
		<h2 class="text-lg font-semibold text-gray-800 mb-4">Upload Testcase</h2>
		<label for="file-upload" class="block text-sm font-medium text-gray-700 mb-2">Upload TXT file</label>
		<input type="file" id="file-upload" name="file-upload" accept=".txt" class="w-full border rounded p-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400" />
	</section>

	<!-- Input Form -->
	<section class="bg-white rounded-lg shadow p-6">
		<form method="POST" class="space-y-4">
			{% csrf_token %}
			<label for="text" class="block text-sm font-medium text-gray-700">Input Text</label>
			<textarea id="text" name="text" rows="8" placeholder="Enter your queries here..." class="w-full border rounded p-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400">{{ input_text|default:"" }}</textarea>
			<input type="hidden" id="isDebug" name="isDebug" value="false" />
			<button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-4 rounded-lg shadow-md transition w-full sm:w-auto">
				<i class="fas fa-play"></i> Run
			</button>
		</form>
	</section>

	<!-- Actions Section -->
	<section class="bg-gray-50 rounded-lg shadow p-6 flex flex-col sm:flex-row gap-4 items-center justify-between">
		<div class="flex gap-2">
			<button onclick="copyToClipboard()" class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-lg shadow-md transition flex items-center gap-2">
				<i class="fas fa-copy"></i> Copy Output
			</button>
			<a id="download-btn" class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-4 rounded-lg shadow-md transition flex items-center gap-2">
				<i class="fas fa-download"></i> Download Output
			</a>
		</div>
		<label class="flex items-center gap-2">
			<input type="checkbox" id="debugger-toggle" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
			<span class="text-gray-700 text-sm">Enable Debugger</span>
		</label>
	</section>

	<!-- Execution Section -->
	{% if time %}
	<section class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 shadow">
		<h2 class="text-yellow-700 font-semibold flex items-center gap-2">
			<i class="fas fa-clock"></i> Execution Duration
		</h2>
		<p class="text-gray-800">{{ time }} seconds</p>
	</section>
	{% endif %}

	<!-- Output Section -->
	{% if output %}
	<section class="bg-green-50 border border-green-300 rounded-lg p-4 shadow">
		<h2 class="text-green-700 font-semibold flex items-center gap-2">
			<i class="fas fa-check-circle"></i> Output
		</h2>
		<pre id="output-text" class="text-gray-800 whitespace-pre-wrap overflow-x-auto">{{ output }}</pre>
	</section>
	{% endif %}

	<!-- Error Section -->
	{% if error %}
	<section class="bg-red-50 border border-red-300 rounded-lg p-4 shadow">
		<h2 class="text-red-700 font-semibold flex items-center gap-2">
			<i class="fas fa-exclamation-circle"></i> Error
		</h2>
		<pre class="text-red-700 whitespace-pre-wrap">{{ error }}</pre>
		{% if details %}
		<h3 class="text-red-700 font-medium mt-4 flex items-center gap-2">
			<i class="fas fa-info-circle"></i> Details
		</h3>
		<pre class="text-red-600 whitespace-pre-wrap">{{ details }}</pre>
		{% endif %}
	</section>
	{% endif %}
</div>

<script>
// File upload logic
document.getElementById("file-upload").addEventListener("change", function (event) {
	const file = event.target.files[0];
	if (file && file.type === "text/plain") {
		const reader = new FileReader();
		reader.onload = function (e) {
			const rawText = e.target.result.replace(/<script.*?>.*?<\/script>/gi, "").replace(/<.*?>/g, "");
			document.getElementById("text").value = rawText;
		};
		reader.readAsText(file);
	} else {
		alert("Please upload a valid .txt file.");
	}
});

// Debugger logic
document.getElementById("debugger-toggle").addEventListener("change", function () {
	const isDebugField = document.getElementById("isDebug");
	const url = new URL(window.location.href);

	if (this.checked) {
		isDebugField.value = "true";
		url.searchParams.set("debug", "true");
	} else {
		isDebugField.value = "false";
		url.searchParams.delete("debug");
	}

	console.log(`Debugger is now ${isDebugField.value}`);
	window.history.replaceState({}, "", url);
});

// Copy to clipboard
function copyToClipboard() {
	const outputText = document.getElementById("output-text")?.innerText || "";
	navigator.clipboard.writeText(outputText)
		.then(() => alert("Output copied to clipboard!"))
		.catch((err) => console.error("Copy failed: ", err));
}

// Download output
document.addEventListener("DOMContentLoaded", function () {
	const outputText = document.getElementById("output-text")?.innerText || "";
	const downloadBtn = document.getElementById("download-btn");
	if (downloadBtn && outputText) {
		const blob = new Blob([outputText], { type: "text/plain" });
		const url = URL.createObjectURL(blob);
		downloadBtn.href = url;
		downloadBtn.download = "output.txt";
	}

	const debug = new URLSearchParams(window.location.search).get("debug");
	if (debug === "true") {
		document.getElementById("debugger-toggle").checked = true;
		document.getElementById("isDebug").value = "true";
	}
});
</script>
{% endblock content %}
